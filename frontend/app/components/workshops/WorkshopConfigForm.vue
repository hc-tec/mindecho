<script setup lang="ts">
import { ref, watchEffect, computed, watch, nextTick, triggerRef } from 'vue'
import { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog'
import { Input } from '@/components/ui/input'
import { Button } from '@/components/ui/button'
import { Textarea } from '@/components/ui/textarea'
import { Switch } from '@/components/ui/switch'
import { Label } from '@/components/ui/label'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue, SelectGroup, SelectLabel } from '@/components/ui/select'
import { Settings2 } from 'lucide-vue-next'
import { useWorkshopsStore } from '@/stores/workshops'
import { useCollectionsStore } from '@/stores/collections'
import WorkshopPlatformBindings from './WorkshopPlatformBindings.vue'
import AIModelSelector from '@/components/common/AIModelSelector.vue'
import type { Workshop } from '@/types/api'
import { api } from '@/lib/api'

const props = defineProps<{
  open: boolean
  workshop?: Workshop | null
}>()
const emits = defineEmits<{
  (e: 'update:open', value: boolean): void
  (e: 'saved'): void
}>()

const store = useWorkshopsStore()
const collectionsStore = useCollectionsStore()

const isEdit = ref(false)
const name = ref('')
const workshopId = ref('') // slug
const description = ref('')
const defaultPrompt = ref('')
const defaultModel = ref('yuanbao-chat')  // Êõ¥Êñ∞ÈªòËÆ§ÂÄº‰∏∫Êñ∞ÁöÑÊ®°ÂûãIDÊ†ºÂºè
const executorType = ref('llm_chat')
const executorConfig = ref<Record<string, any> | null>(null)
const executorConfigText = ref('')

// Listening configuration
const listeningEnabled = ref(false)
const platformBindingsDialogOpen = ref(false)
const platformBindingsSummary = ref('Êú™ÈÖçÁΩÆ')  // ÊîπÁî® ref ËÄå‰∏çÊòØ computed

// Helper: get collection by ID
const getCollectionById = (collectionId: number) => {
  return collectionsStore.platformCollections.find(c => c.id === collectionId)
}

// Helper: ÊâãÂä®ËÆ°ÁÆó platform bindings summary
const updatePlatformBindingsSummary = () => {
  const bindings = executorConfig.value?.platform_bindings || []
  if (!bindings || bindings.length === 0) {
    platformBindingsSummary.value = 'Êú™ÈÖçÁΩÆ'
    return
  }

  const parts: string[] = []

  bindings.forEach((b: any) => {
    const platformIcon = b.platform === 'bilibili' ? 'üì∫' : b.platform === 'xiaohongshu' ? 'üìï' : 'üìÅ'
    const collectionNames = b.collection_ids
      .map((id: number) => getCollectionById(id)?.title)
      .filter((title: string | undefined) => title !== undefined)

    if (collectionNames.length > 0) {
      parts.push(`${platformIcon} ${collectionNames.join('„ÄÅ')}`)
    } else {
      const platformName = b.platform === 'bilibili' ? 'BÁ´ô' : b.platform === 'xiaohongshu' ? 'Â∞èÁ∫¢‰π¶' : b.platform
      parts.push(`${platformIcon} ${platformName}(${b.collection_ids.length}‰∏™)`)
    }
  })

  platformBindingsSummary.value = parts.join(' | ')
  console.log('üîÑ platformBindingsSummary Â∑≤Êõ¥Êñ∞‰∏∫:', platformBindingsSummary.value)
}

watchEffect(() => {
  if (props.workshop) {
    isEdit.value = true
    name.value = props.workshop.name
    // @ts-ignore backend returns workshop_id
    workshopId.value = (props.workshop as any).workshop_id || ''
    description.value = props.workshop.description || ''
    // map older fields to new defaults if present
    // @ts-ignore
    defaultPrompt.value = (props.workshop as any).default_prompt || props.workshop.system_prompt || ''
    // @ts-ignore
    defaultModel.value = (props.workshop as any).default_model || props.workshop.model || 'gpt-4o-mini'
    // @ts-ignore
    executorType.value = (props.workshop as any).executor_type || (props.workshop as any).type || 'generic'
    // @ts-ignore
    executorConfig.value = (props.workshop as any).executor_config || (props.workshop as any).config || null
    executorConfigText.value = executorConfig.value ? JSON.stringify(executorConfig.value, null, 2) : ''

    // Load listening config
    listeningEnabled.value = executorConfig.value?.listening_enabled || false

    // ÊâãÂä®Êõ¥Êñ∞ summary
    updatePlatformBindingsSummary()
  } else {
    isEdit.value = false
    name.value = ''
    workshopId.value = ''
    description.value = ''
    defaultPrompt.value = ''
    defaultModel.value = 'gpt-4o-mini'
    executorType.value = 'generic'
    executorConfig.value = null
    executorConfigText.value = ''
    listeningEnabled.value = false
    platformBindingsSummary.value = 'Êú™ÈÖçÁΩÆ'
  }
})

const saving = ref(false)

const handleSave = async () => {
  saving.value = true
  try {
    // Parse JSON text if user manually edited it
    if (executorConfigText.value.trim()) {
      try {
        executorConfig.value = JSON.parse(executorConfigText.value)
      } catch (e) {
        alert('ÊâßË°åÂô®ÈÖçÁΩÆ‰∏çÊòØÊúâÊïàÁöÑ JSON')
        saving.value = false
        return
      }
    }

    // Ensure executor_config exists
    if (!executorConfig.value) {
      executorConfig.value = {}
    }

    // Update listening_enabled
    executorConfig.value.listening_enabled = listeningEnabled.value

    console.log('üíæ Saving executor_config:', executorConfig.value)

    if (isEdit.value && props.workshop) {
      await store.updateWorkshop(workshopId.value || (props.workshop as any).workshop_id, {
        name: name.value,
        description: description.value,
        // backend unified fields
        // @ts-ignore
        default_prompt: defaultPrompt.value,
        // @ts-ignore
        default_model: defaultModel.value,
        // @ts-ignore
        executor_type: executorType.value,
        // @ts-ignore
        executor_config: executorConfig.value,
      } as any)
    } else {
      await store.createWorkshop({
        // @ts-ignore
        workshop_id: workshopId.value,
        name: name.value,
        description: description.value,
        // @ts-ignore
        default_prompt: defaultPrompt.value,
        // @ts-ignore
        default_model: defaultModel.value,
        // @ts-ignore
        executor_type: executorType.value,
        // @ts-ignore
        executor_config: executorConfig.value,
      } as any)
    }
    emits('saved')
    emits('update:open', false)
  } finally {
    saving.value = false
  }
}

const openPlatformBindings = () => {
  platformBindingsDialogOpen.value = true
}

const onBindingsSaved = async () => {
  if (!workshopId.value) {
    console.warn('‚ùå No workshop ID')
    return
  }

  console.log('üîÑ Êî∂ËóèÂ§πÈÖçÁΩÆ‰øùÂ≠òÂÆåÊàêÔºåÂà∑Êñ∞Êï∞ÊçÆ...')
  console.log('   Workshop ID:', workshopId.value)

  try {
    // 1. ÂÖàÂà∑Êñ∞ collections Êï∞ÊçÆ
    console.log('   Âà∑Êñ∞ collections...')
    await collectionsStore.fetchPlatformCollections()
    console.log('   ‚úì Collections Â∑≤Âà∑Êñ∞ÔºåÊÄªÊï∞:', collectionsStore.platformCollections.length)

    // 2. ÈáçÊñ∞Ëé∑ÂèñÊúÄÊñ∞Êï∞ÊçÆ
    const updated = await store.fetchWorkshopBySlug(workshopId.value)

    if (!updated) {
      console.error('‚ùå Ëé∑ÂèñÊõ¥Êñ∞ÂêéÁöÑÂ∑•ÂùäÊï∞ÊçÆÂ§±Ë¥•')
      return
    }

    console.log('‚úì Ëé∑ÂèñÂà∞Êõ¥Êñ∞ÂêéÁöÑÂ∑•Âùä:', updated)

    const newExecutorConfig = (updated as any).executor_config
    console.log('‚úì Êñ∞ÁöÑ executor_config:', newExecutorConfig)
    console.log('‚úì ÂåÖÂê´ platform_bindings:', newExecutorConfig?.platform_bindings)

    // ÂÖ≥ÈîÆÔºöÂº∫Âà∂ÊõøÊç¢Êï¥‰∏™ÂØπË±°ÔºåÁ°Æ‰øùËß¶ÂèëÔøΩÔøΩÂ∫îÂºèÊõ¥Êñ∞
    executorConfig.value = { ...newExecutorConfig }
    executorConfigText.value = JSON.stringify(executorConfig.value, null, 2)
    listeningEnabled.value = executorConfig.value?.listening_enabled || false

    // Âº∫Âà∂Ëß¶ÂèëÂìçÂ∫îÂºè
    triggerRef(executorConfig)
    await nextTick()

    console.log('‚úÖ executorConfig.value Â∑≤Êõ¥Êñ∞!', executorConfig)
    console.log('   platform_bindings:', executorConfig.value?.platform_bindings)

    // 3. ÊâãÂä®Êõ¥Êñ∞ platformBindingsSummary
    updatePlatformBindingsSummary()
    console.log('   ‚úì updatePlatformBindingsSummary Â∑≤Ë∞ÉÁî®')

    // 4. ÊµãËØïÔºöËØªÂèñÊõ¥Êñ∞ÂêéÁöÑÂÄº
    const testSummary = platformBindingsSummary.value
    console.log('   üìä platformBindingsSummary ÊúÄÁªàÂÄº:', testSummary)

    if (testSummary === 'Êú™ÈÖçÁΩÆ') {
      console.warn('‚ö†Ô∏è  platformBindingsSummary ‰ªçÁÑ∂ÊòæÁ§∫"Êú™ÈÖçÁΩÆ"')
      console.log('   Ê£ÄÊü• collections:', collectionsStore.platformCollections.slice(0, 3))
    } else {
      console.log('‚úÖ platformBindingsSummary Â∑≤Ê≠£Á°ÆÊõ¥Êñ∞!')
    }
  } catch (error) {
    console.error('‚ùå onBindingsSaved Âá∫Èîô:', error)
  }
}

// Load collections when dialog opens
watch(() => props.open, (newVal) => {
  if (newVal) {
    collectionsStore.fetchPlatformCollections()
  }
})
</script>

<template>
  <Dialog :open="open" @update:open="val => emits('update:open', val)">
    <DialogContent class="max-w-2xl">
      <DialogHeader>
        <DialogTitle>{{ isEdit ? 'ÁºñËæëÂ∑•Âùä' : 'Êñ∞Âª∫Â∑•Âùä' }}</DialogTitle>
      </DialogHeader>

      <div class="space-y-4 max-h-[70vh] overflow-y-auto">
        <div>
          <label class="text-sm font-medium">ÂêçÁß∞</label>
          <Input v-model="name" placeholder="Â∑•ÂùäÂêçÁß∞" />
        </div>
        <div>
          <label class="text-sm font-medium">Â∑•Âùä ID (slug)</label>
          <Input v-model="workshopId" placeholder="Â¶Ç information-alchemy" :disabled="isEdit" />
        </div>
        <div>
          <label class="text-sm font-medium">ÊèèËø∞</label>
          <Textarea v-model="description" rows="3" />
        </div>
        <div>
          <label class="text-sm font-medium">ÈªòËÆ§ÊèêÁ§∫ËØç</label>
          <Textarea v-model="defaultPrompt" rows="4" placeholder="Á≥ªÁªüÊèêÁ§∫ËØçÔºåÊîØÊåÅ {source} ÂèòÈáè..." />
        </div>

        <!-- AIÊ®°ÂûãÈÄâÊã©Âô® -->
        <div class="space-y-2">
          <div class="flex flex-col gap-1">
            <label class="text-sm font-medium">AI Ê®°Âûã</label>
            <span class="text-xs text-muted-foreground">
              ÈÄâÊã©Ê≠§Â∑•Âùä‰ΩøÁî®ÁöÑAIÊ®°ÂûãËøõË°åÂÜÖÂÆπÂàÜÊûê
            </span>
          </div>
          <AIModelSelector v-model="defaultModel" />
        </div>

        <div>
          <label class="text-sm font-medium">ÊâßË°åÂô®Á±ªÂûã</label>
          <Input v-model="executorType" placeholder="Â¶Ç llm_chat / generic" />
        </div>

        <!-- Listening Configuration -->
        <Card v-if="isEdit" class="border-primary/20">
          <CardHeader>
            <CardTitle class="text-base flex items-center gap-2">
              <Settings2 class="h-4 w-4" />
              ÁõëÂê¨ÈÖçÁΩÆ
            </CardTitle>
            <CardDescription>ÈÖçÁΩÆÂ∑•ÂùäÁöÑËá™Âä®ÁõëÂê¨‰∏éÂπ≥Âè∞ÁªëÂÆö</CardDescription>
          </CardHeader>
          <CardContent class="space-y-4">
            <div class="flex items-center justify-between">
              <div class="space-y-0.5">
                <Label class="text-sm font-medium">ÂêØÁî®ÁõëÂê¨</Label>
                <p class="text-xs text-muted-foreground">Ëá™Âä®ÁõëÂê¨ÁªëÂÆöÁöÑÊî∂ËóèÂ§πÂπ∂Ëß¶Âèë‰ªªÂä°</p>
              </div>
              <Switch v-model="listeningEnabled" />
            </div>

            <div class="space-y-2">
              <Label class="text-sm font-medium">Âπ≥Âè∞ÁªëÂÆö</Label>
              <div class="flex items-center gap-2">
                <div class="flex-1 px-3 py-2 border rounded-md bg-muted/30 text-sm">
                  {{ platformBindingsSummary }}
                </div>
                <Button
                  type="button"
                  variant="outline"
                  size="sm"
                  @click="openPlatformBindings"
                  :disabled="!workshopId"
                >
                  <Settings2 class="h-4 w-4 mr-1" />
                  ÈÖçÁΩÆ
                </Button>
              </div>
              <p class="text-xs text-muted-foreground">
                ÈÄâÊã©Ë¶ÅÁõëÂê¨ÁöÑÂπ≥Âè∞ÂíåÊî∂ËóèÂ§πÔºåÊîØÊåÅÂ§öÂπ≥Âè∞Â§öÊî∂ËóèÂ§πÁªëÂÆö
              </p>
            </div>
          </CardContent>
        </Card>

        <details class="border rounded-lg p-3">
          <summary class="cursor-pointer text-sm font-medium mb-2">È´òÁ∫ßÈÖçÁΩÆ (JSON)</summary>
          <div class="mt-2">
            <Textarea v-model="executorConfigText" rows="6" placeholder='{"ui": {"icon": "Sparkles"}}' class="font-mono text-xs" />
            <p class="text-xs text-muted-foreground mt-1">
              Áõ¥Êé•ÁºñËæë executor_config JSONÔºàÂåÖÂê´ÁõëÂê¨ÈÖçÁΩÆÔºâ
            </p>
          </div>
        </details>
      </div>

      <div class="flex justify-end gap-2 mt-4">
        <Button variant="ghost" @click="emits('update:open', false)">ÂèñÊ∂à</Button>
        <Button :disabled="saving" @click="handleSave">{{ isEdit ? '‰øùÂ≠ò' : 'ÂàõÂª∫' }}</Button>
      </div>
    </DialogContent>
  </Dialog>

  <!-- Platform Bindings Dialog -->
  <WorkshopPlatformBindings
    v-if="isEdit"
    :open="platformBindingsDialogOpen"
    :workshop-id="workshopId"
    :workshop-name="name"
    @update:open="platformBindingsDialogOpen = $event"
    @saved="onBindingsSaved"
  />
</template>

